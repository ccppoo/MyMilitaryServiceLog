# 코루틴 (1편)

* 서론

* CPU는 너무 빨라

* 딱히 바람직 하지 않았던 방법들

* 사람스럽게 일하기

덧, 멀티스레딩과 멀티프로세싱에 대한 글이 아니기 때문에 간략하게 서술했다.

## 서론 

코루틴이라는 단어가 golang의 부상 이후로 심심치 않게 보이는 것 같았다.

최근에는 코루틴의 관심이 줄었는지, 유튜브를 검색하면 코루틴에 대한 영상이 최근에 많이 안올라오는 것 같다.

코루틴을 이해하기 전에 왜 코루틴이라는 개념이 중요한지, 왜 오래된 개념임에도 불구하고 계속해서 (비교적)최신 언어에서 화제가 되는지

이해하고, 스스로 정리할 필요가 있다고 생각해 이 글을 쓰도록 마음 먹었다.

그리고 파이썬 문서 "PEP342 - Coroutines via Enhanced Generators"를 번역을 하다가

번뜩, 왜 파이썬에서 yield syntax가 이렇게 만들어졌고, 무엇을 의도했는지를 깨달은 것이 동기 중 하나였다.

예전에는 제너레이터, 비동기, async/await 문법을 보면서 맨날 코드를 보며 간접적으로 익혔을 뿐, 개념은 몰라서

코드를 정작 작성해도 "대충 굴러가니깐~" 하고 그 원리는 자세히 알아보지 않았었다.

그럼 이제 비동기 프로그래밍은 어디에서 출발했는지 알아보자

## CPU는 너무 빨라

모든 프로그램은 파일 시스템을 통해서 필요한 데이터의 I/O 과정이 이루어진다.

쉽게 말하자면, 메모리를 읽고 쓰는 일을 반복한다는 의미다.

하는 일이 더하기(+) 빼기(-)가 전부인 CPU는 미친듯한 속도로 일을 처리한다.

메모리를 읽고 쓰는데 쓰이는 시간이 **연산을 하는 시간보다 더 많이 소요되는** 상황이 일어난다. 

그럼 그동안 남는 시간은 CPU가 읽고/쓰라는 메모리의 위치를 기다리느라 아무 일도 안한다...

할 일이 수십만개가 쌓인 경우 수십만번의 지연이 발생될 것이고

결국 우리가 렉(lag)이 발생한다는 것을 체감할 수 있는 것이다.

그럼 CPU가 일을 기다리는 동안 다른 일을 시켜서 미리 미리 하도록 하면 어떨까?

## CPU에게 동시에 일 여러개 시키기

프로그램에서 동시에 여러가지 일을 수행하도록 하는 방법으로 많이 들어본 것은

* 멀티스레딩 (Multi - Threading)

* 멀티프로세싱 (Multi - Processing)

이 두가지가 있을 것이다.

친숙한 사람으로 비유하면

멀티스레딩은 한 사람(프로세서)에게 Do-List(스레드)를 여러개 쥐어주는 것이고

멀티프로세싱은 여러 사람(프로세서)에게 각각 Do-List(스레드)를 주는 것이다.

돈(시간, 자원)이 많으면 상관 없겠지만, 컴퓨팅의 최종목적은 '최소의 자원으로 최고의 효율을 내는 것'이다.

## 딱히 바람직 하지 않았던 방법들

멀티 스레딩과 멀티 프로세싱이 있으면 뭐가 문제겠냐 싶겠지만,

멀티 스레딩은 여러개의 Do-List에 있는 일의 강도와 대기 상황(일 안하고 휴무) 상관 없이

공평한 시간만큼(1/n) 모든 Do-List의 일을 해야하기 때문에

중간에 일이 완료되지 않았음에도 불구하고, 잠시 중단한 뒤 다른 Do-list를 해야된다.

일이 완료되지 않거나 잠깐 기다리는 상황이 아닌데도 중단하고 다른 일로 넘어가야되는 만큼

**하던 일을 중지**하고, 그 일을 **다시 불러오는**데 시간을 낭비할 확률이 높다.

그리고 일 자체가 실행중에 중지를 못하고 계속 실행 될 수 있어 (blocking)

의도와 다르게 다른 일을 하도록(release) 못하는 경우도 발생할 수 있다. - 튜링머신의 개념을 떠올려보자!

...

멀티 프로세싱의 경우 여러사람에게 Do-list를 적당히 쪼개어 일을 나눠주는 것 자체가 어렵고,

사람간에 통신이 필요한 경우, 추가적인 비용(시간)이 들고, 프로세스 자체가 비싼 물리적인 자원이기 때문에

주어진 일에 비해 과분(낭비)할 확률이 높다.

## 사람스럽게 일하기 

우리는 살면서 많은 일들을 (거의) 동시에 진행하고 있다.

책을 인터넷을 통해 구매하는 일을 떠올려보자.

책을 주문을 한뒤 우리는 책이 오기까지 계속 문앞에 서서 택배 배달원을 기다리지 않는다.

다음과 같은 과정을 거친다.

1. 나에게 있어 '책 주문'이라는 작업에서 잠시 중단(suspend)하고

2. 다른 일을 하고 난 뒤에

3. 집 앞에 책이 배달된지 확인

4. 책이 집 앞에 배달이 안되어 있으면 3번으로 / 되어 있으면 5번으로

5. 배달된 책을 들고 집으로 가져온다

일반적으로 1번 과정에서 책을 결재를 하던 도중 다른일을 하러가지 않고, **적당히** 하나의 과정이 끝났다고 판단되면

다음 과정으로 넘어간다. 그리고 이를 제어하는 것은 본인 자신이다.

위와 같이 '적당한' 지점에서 한 작업을 중단하고 (의식x) 다른 일을 하러 가는 것이

corutine의 인간적인 이해다.

------------

2편에서 계속